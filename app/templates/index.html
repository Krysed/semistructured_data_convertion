<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data conversion tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen py-8 px-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl md:text-4xl font-bold text-blue-600 mb-6 text-center">Data conversion tool</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <input type="number" id="record-count" placeholder="Enter number of records" value="10000"
             class="px-4 py-2 rounded-xl border border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-400 w-full" />
      <button id="generate-btn"
              class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition w-full">
        Generate XML
      </button>
      <button id="convert-btn"
              class="bg-yellow-500 text-white px-4 py-2 rounded-xl hover:bg-yellow-600 transition w-full">
        Convert to JSON
      </button>
      <button id="download-yml-btn"
              class="bg-purple-600 text-white px-4 py-2 rounded-xl hover:bg-purple-700 transition w-full">
        Download YML
      </button>
      <button id="toggle-xml-btn"
              class="bg-indigo-500 text-white px-4 py-2 rounded-xl hover:bg-indigo-600 transition w-full">
        Show XML
      </button>
      <button id="query-debt-btn"
              class="bg-rose-500 text-white px-4 py-2 rounded-xl hover:bg-rose-600 transition w-full">
        Query Debt by City
      </button>
      <button id="top-debt-btn"
              class="bg-green-600 text-white px-4 py-2 rounded-xl hover:bg-green-700 transition w-full">
        Show Top Cities by Debt
      </button>
      <button id="query-all-btn"
              class="bg-slate-600 text-white px-4 py-2 rounded-xl hover:bg-slate-700 transition w-full">
        Show All Records
      </button>
    </div>

    <div id="loading-indicator" class="mb-4 hidden p-4 bg-yellow-100 border border-yellow-400 rounded-xl text-center">
      <span class="text-yellow-700 font-medium">Loading...</span>
    </div>

    <pre id="xml-display"
         class="hidden bg-white border border-gray-300 p-4 rounded-xl whitespace-pre-wrap max-h-96 overflow-auto mb-6"></pre>

    <div class="overflow-auto">
      <table id="debt-table" class="hidden w-full text-left border border-gray-300 mb-6">
        <thead class="bg-blue-100 text-blue-800 font-semibold">
          <tr>
            <th class="border border-gray-300 p-2">City</th>
            <th class="border border-gray-300 p-2">Total Debt</th>
          </tr>
        </thead>
        <tbody id="debt-table-body"></tbody>
      </table>

      <table id="all-records-table" class="hidden w-full text-left border border-gray-300 mb-6">
        <thead>
          <tr></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
    
  <script>
    document.getElementById('generate-btn').addEventListener('click', function () {
      const numRecords = parseInt(document.getElementById('record-count').value) || 10000;
      fetch('http://localhost:8000/generate_xml', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ num_of_records: numRecords, currency: 'PLN' })
      })
      .then(response => response.json())
      .then(data => alert(data.message || "XML generated successfully."))
      .catch(error => {
        console.error("Error:", error);
        alert("There was an error generating the XML file.");
      });
    });

    document.getElementById('convert-btn').addEventListener('click', function () {
      fetch('http://localhost:8000/convert_xml_to_json', { method: 'POST' })
        .then(response => response.json())
        .then(data => alert(data.message || "XML converted to JSON and stored in MongoDB."))
        .catch(error => {
          console.error("Error:", error);
          alert("There was an error converting XML to JSON.");
        });
    });

    document.getElementById('download-yml-btn').addEventListener('click', function () {
      fetch('http://localhost:8000/download_yml')
        .then(response => response.blob())
        .then(blob => {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'data.yml';
          link.click();
        })
        .catch(error => {
          console.error("Error:", error);
          alert("There was an error downloading the YAML file.");
        });
    });

    let xmlLoaded = false;

    document.getElementById('toggle-xml-btn').addEventListener('click', function () {
      const display = document.getElementById('xml-display');
      const toggleBtn = document.getElementById('toggle-xml-btn');

      if (!xmlLoaded) {
        fetch('http://localhost:8000/get_xml')
          .then(response => response.text())
          .then(data => {
            display.textContent = data.trim() || "No XML file found.";
            display.style.display = "block";
            toggleBtn.textContent = "Hide XML";
            xmlLoaded = true;
          })
          .catch(error => {
            console.error("Error:", error);
            display.textContent = "Error loading XML file.";
            display.style.display = "block";
            toggleBtn.textContent = "Hide XML";
          });
      } else {
        if (display.style.display === "none") {
          display.style.display = "block";
          toggleBtn.textContent = "Hide XML";
        } else {
          display.style.display = "none";
          toggleBtn.textContent = "Show XML";
        }
      }
    });

    document.getElementById('top-debt-btn').addEventListener('click', function () {
      fetch('http://localhost:8000/stats/top_cities_by_debt')
        .then(response => response.json())
        .then(responseData => {
          const data = responseData.data;
          const table = document.getElementById('debt-table');
          const tbody = table.querySelector('tbody');
          tbody.innerHTML = '';

          if (Array.isArray(data)) {
            data.forEach(row => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="border: 1px solid #ccc; padding: 8px;">${row._id}</td>
                <td style="border: 1px solid #ccc; padding: 8px;">${row.total_debt.toFixed(2)}</td>
              `;
              tbody.appendChild(tr);
            });
            table.style.display = "table";
          } else {
            alert("No data returned.");
            table.style.display = "none";
          }
        })
        .catch(error => {
          console.error("Error:", error);
          alert("Failed to fetch city debt stats.");
        });
    });

    document.getElementById('query-debt-btn').addEventListener('click', function () {
      document.getElementById('loading-indicator').style.display = 'block';

      fetch('http://localhost:8000/stats/top_cities_by_debt')
        .then(response => response.json())
        .then(responseData => {
          document.getElementById('loading-indicator').style.display = 'none';

          const data = responseData.data;
          const tableBody = document.getElementById('debt-table-body');
          tableBody.innerHTML = '';

          if (Array.isArray(data) && data.length) {
            data.forEach(item => {
              const row = document.createElement('tr');
              const cityCell = document.createElement('td');
              const debtCell = document.createElement('td');
              cityCell.textContent = item._id;
              debtCell.textContent = item.total_debt.toFixed(2);
              row.appendChild(cityCell);
              row.appendChild(debtCell);
              tableBody.appendChild(row);
            });
          } else {
            const row = document.createElement('tr');
            const noDataCell = document.createElement('td');
            noDataCell.colSpan = 2;
            noDataCell.textContent = 'No data available';
            row.appendChild(noDataCell);
            tableBody.appendChild(row);
          }
        })
        .catch(error => {
          document.getElementById('loading-indicator').style.display = 'none';
          console.error("Error:", error);
          alert("There was an error fetching the debt data.");
        });
    });

    document.getElementById('query-all-btn').addEventListener('click', async () => {
      try {
        console.log("Fetching all records...");
        const resp = await fetch('http://localhost:8000/stats/all_records');
        const payload = await resp.json();

        if (payload.status !== 'success' || !Array.isArray(payload.data)) {
          console.error("Unexpected response:", payload);
          alert("Failed to fetch records.");
          return;
        }

        console.log("All records:", payload.data);

        const table = document.getElementById('all-records-table');
        const thead = table.querySelector('thead tr');
        const tbody = table.querySelector('tbody');

        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (payload.data.length === 0) {
          alert("No records in database.");
          table.style.display = 'none';
          return;
        }

        const columns = Object.keys(payload.data[0]);
        columns.forEach(col => {
          const th = document.createElement('th');
          th.textContent = col;
          th.style = 'border:1px solid #ccc; padding:8px;';
          thead.appendChild(th);
        });

        payload.data.forEach(doc => {
          const tr = document.createElement('tr');
          columns.forEach(col => {
            const td = document.createElement('td');
            td.textContent = doc[col];
            td.style = 'border:1px solid #ccc; padding:8px;';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.style.display = 'table';

      } catch (err) {
        console.error("Error fetching all records:", err);
        alert("Error loading records – check console for details.");
      }
    });
  </script>
</body>
</html>
